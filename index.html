<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TandilProp Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        body { position: fixed; width: 100%; height: 100%; overflow: hidden; }
        #map { height: calc(100vh - 160px); width: 100%; z-index: 1; }
        .view { position: absolute; inset: 0; bottom: 80px; background: white; z-index: 10; display: none; overflow-y: auto; }
        .view.active { display: block; }
        .video-ad { position: fixed; inset: 0; background: black; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
    </style>
</head>
<body class="bg-slate-100">

    <div id="video-ad" class="video-ad">
        <div class="p-6 text-center">
            <h2 class="text-indigo-500 font-black text-xl mb-4 italic">TandilProp Ads</h2>
            <div class="w-64 h-40 bg-slate-800 rounded-3xl mb-4 flex items-center justify-center border border-slate-700">
                <span class="text-sm font-bold">TU PUBLICIDAD AQUÍ</span>
            </div>
            <p id="ad-timer" class="text-xs text-slate-400">Cargando datos...</p>
        </div>
    </div>

    <div class="flex flex-col h-full max-w-lg mx-auto bg-white relative">
        <header class="h-16 flex items-center px-6 border-b bg-white justify-between">
            <h1 class="font-black text-indigo-600 italic text-xl">TANDILPROP</h1>
            <button onclick="location.reload()" class="text-xs font-bold bg-slate-100 px-3 py-1 rounded-lg border">REFRESCAR</button>
        </header>

        <div id="view-map" class="view active" style="bottom: 80px;">
            <div id="map"></div>
            <div class="h-16 bg-slate-900 flex items-center px-4 justify-between">
                <p class="text-[10px] text-white font-bold">SPONSOR: MUDANZAS TANDIL</p>
                <button class="bg-indigo-600 text-[9px] text-white px-3 py-1 rounded font-black">INFO</button>
            </div>
        </div>

        <div id="view-list" class="view p-4">
            <h2 class="font-black text-sm mb-4 uppercase text-slate-400">Propiedades Cargadas</h2>
            <div id="list-container" class="space-y-4"></div>
        </div>

        <div id="view-add" class="view p-6">
            <h2 class="text-xl font-black mb-4 italic">Publicar Propiedad</h2>
            <div class="space-y-3">
                <input type="text" id="p-title" placeholder="Título" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none">
                <input type="number" id="p-price" placeholder="Precio USD" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none">
                <div class="flex gap-2">
                    <input type="text" id="p-address" placeholder="Dirección en Tandil" class="flex-1 p-4 bg-indigo-50 border rounded-2xl outline-none">
                    <button onclick="searchGeo()" class="bg-indigo-600 text-white px-4 rounded-2xl font-black text-[10px]">UBICAR</button>
                </div>
                <input type="text" id="p-wa" placeholder="WhatsApp (2494...)" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none">
                <input type="text" id="p-img" placeholder="Link Foto" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none">
                <button onclick="publish()" class="w-full bg-slate-900 text-white py-5 rounded-3xl font-black uppercase mt-4 shadow-xl">Subir a la Nube ☁️</button>
            </div>
        </div>

        <nav class="h-20 border-t flex justify-around items-center bg-white z-[1000]">
            <button onclick="changeTab('map')" class="flex flex-col items-center">
                <span class="text-[10px] font-black uppercase text-indigo-600">Mapa</span>
            </button>
            <button onclick="changeTab('add')" class="bg-indigo-600 text-white w-14 h-14 rounded-2xl text-3xl shadow-xl -mt-10 border-4 border-white">+</button>
            <button onclick="changeTab('list')" class="flex flex-col items-center">
                <span class="text-[10px] font-black uppercase text-slate-400">Lista</span>
            </button>
        </nav>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBUViSxd76R5Xc3h4obWtbkGEXADPH8qTw",
            authDomain: "tandilprop-56ec1.firebaseapp.com",
            projectId: "tandilprop-56ec1",
            storageBucket: "tandilprop-56ec1.firebasestorage.app",
            messagingSenderId: "777799820024",
            appId: "1:777799820024:web:e4c0d80f048a740456910d",
            databaseURL: "https://tandilprop-56ec1-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref('propiedades_final');

        let map = L.map('map', {zoomControl: false}).setView([-37.3217, -59.1332], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let cLat = -37.3217, cLng = -59.1332;

        function changeTab(tabId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + tabId).classList.add('active');
            if(tabId === 'map') setTimeout(() => map.invalidateSize(), 300);
        }

        async function searchGeo() {
            const addr = document.getElementById('p-address').value;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr + ', Tandil, Argentina')}`);
            const data = await res.json();
            if(data.length > 0) {
                cLat = parseFloat(data[0].lat); cLng = parseFloat(data[0].lon);
                map.setView([cLat, cLng], 17);
                alert("Ubicación encontrada.");
            } else { alert("Dirección no encontrada."); }
        }

        function publish() {
            const title = document.getElementById('p-title').value;
            const price = document.getElementById('p-price').value;
            const wa = document.getElementById('p-wa').value;
            const img = document.getElementById('p-img').value;
            if(!title || !price) return alert("Completá los campos.");

            db.push({ title, price, wa, img, lat: cLat, lng: cLng }).then(() => {
                alert("¡Publicado!");
                changeTab('map');
            });
        }

        function showAd(callback) {
            const ad = document.getElementById('video-ad');
            ad.style.display = 'flex';
            let timer = 3;
            const interval = setInterval(() => {
                timer--;
                document.getElementById('ad-timer').innerText = "Abriendo en " + timer + "s...";
                if(timer <= 0) {
                    clearInterval(interval);
                    ad.style.display = 'none';
                    callback();
                }
            }, 1000);
        }

        db.on('value', snap => {
            const data = snap.val();
            const list = data ? Object.values(data) : [];
            
            // Render Pins
            map.eachLayer(l => { if(l instanceof L.Marker) map.removeLayer(l) });
            list.forEach(p => {
                L.marker([p.lat, p.lng]).addTo(map).on('click', () => {
                    showAd(() => alert(p.title + " - U$D " + p.price));
                });
            });

            // Render Lista
            document.getElementById('list-container').innerHTML = list.map(p => `
                <div class="bg-white border rounded-3xl p-3 shadow-sm">
                    <img src="${p.img || 'https://via.placeholder.com/400x200'}" class="w-full h-40 object-cover rounded-2xl mb-3">
                    <h3 class="font-black uppercase italic text-sm">${p.title}</h3>
                    <p class="text-indigo-600 font-black text-lg">U$D ${p.price}</p>
                    <button onclick="showAd(() => window.open('https://wa.me/${p.wa}'))" class="w-full bg-slate-900 text-white py-3 rounded-xl mt-2 text-[10px] font-bold">CONTACTAR</button>
                </div>
            `).reverse().join('');
        });
    </script>
</body>
</html>
